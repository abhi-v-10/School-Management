{% extends "base.html" %}
{% block title %}My Profile{% endblock %}

{% block extra_css %}
<style>
  .profile-wrapper { max-width: 460px; margin: 0 auto; }
  .profile-card { border: 1px solid #e5e7eb; border-radius: 16px; padding: 2.25rem 2rem 2rem; background:#fff; box-shadow: 0 4px 16px rgba(0,0,0,.04); }
  .profile-card h2 { font-size: 1.4rem; font-weight:600; text-align:center; margin-bottom: 1.75rem; }
  .avatar-wrapper { position: relative; width: 160px; height:160px; margin:0 auto 1.5rem; cursor:pointer; }
  .avatar-wrapper img, .avatar-initials { width:100%; height:100%; border-radius:50%; object-fit:cover; display:flex; align-items:center; justify-content:center; font-size:56px; font-weight:600; border:4px solid #f0f2f5; background:#f3f6fa; color:#1875FF; }
  .avatar-overlay { position:absolute; inset:0; background:rgba(0,0,0,.5); color:#fff; border-radius:50%; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px; font-size:.9rem; font-weight:500; opacity:0; transition:opacity .25s ease; text-align:center; padding:0 .75rem; }
  .avatar-wrapper:hover .avatar-overlay, .avatar-wrapper:focus-within .avatar-overlay { opacity:1; }
  .form-section .form-label { font-weight:500; font-size:.85rem; letter-spacing:.3px; color:#555; margin-bottom:4px; }
  .form-section .form-control { border-radius:10px; padding:.65rem .85rem; border:1px solid #d8dde3; }
  .form-section .form-control:focus { border-color:#1875FF; box-shadow:0 0 0 3px rgba(24,117,255,.15); }
  .actions { display:flex; gap:.75rem; margin-top:1.25rem; }
  .actions .role-btn { flex:1; }
  @media (max-width:576px){ .profile-card { padding:2rem 1.25rem 1.5rem; } }
</style>
{% endblock %}

{% block content %}
<div class="profile-wrapper">
  <div class="profile-card">
    <h2>My Profile</h2>
    <form method="post" enctype="multipart/form-data" novalidate>
      {% csrf_token %}
      <div class="avatar-wrapper" id="avatarWrapper" aria-label="Change profile photo" title="Click to change photo">
        {% if form.instance.profile_photo %}
          <img src="{{ form.instance.profile_photo.url }}" id="avatarPreview" alt="Profile Photo">
        {% else %}
          <div id="avatarPreview" class="avatar-initials">{{ form.instance.get_full_name|default:form.instance.username|slice:":1"|upper }}</div>
        {% endif %}
        <div class="avatar-overlay"><i class="bi bi-camera" style="font-size:1.3rem;"></i><span>Change Photo</span></div>
      </div>
      <input type="file" name="profile_photo" id="id_profile_photo" accept="image/*" hidden>
      {% if form.profile_photo.errors %}<div class="text-danger small text-center mb-2">{{ form.profile_photo.errors|striptags }}</div>{% endif %}
      <div class="text-center small text-muted mb-3">JPG / PNG â€¢ Max 5MB</div>

      <div class="form-section d-flex flex-column gap-3">
        <div>
          <label class="form-label">Username</label>
          {{ form.username }}
          {% if form.username.errors %}<div class="text-danger small mt-1">{{ form.username.errors|striptags }}</div>{% endif %}
        </div>
        <div>
          <label class="form-label">Email</label>
          {{ form.email }}
          {% if form.email.errors %}<div class="text-danger small mt-1">{{ form.email.errors|striptags }}</div>{% endif %}
        </div>
        <div>
          <label class="form-label">First name</label>
          {{ form.first_name }}
          {% if form.first_name.errors %}<div class="text-danger small mt-1">{{ form.first_name.errors|striptags }}</div>{% endif %}
        </div>
        <div>
          <label class="form-label">Last name</label>
          {{ form.last_name }}
          {% if form.last_name.errors %}<div class="text-danger small mt-1">{{ form.last_name.errors|striptags }}</div>{% endif %}
        </div>
        {% if form.phone_number %}
        <div>
          <label class="form-label">Mobile Number</label>
          {{ form.phone_number }}
          {% if form.phone_number.errors %}<div class="text-danger small mt-1">{{ form.phone_number.errors|striptags }}</div>{% endif %}
        </div>
        {% endif %}
      </div>

      <div class="actions">
        <button class="role-btn" type="submit"><span><i class="bi bi-check2-all"></i> Save</span></button>
        <a href="{% url 'home' %}" class="role-btn"><span><i class="bi bi-x-lg"></i> Cancel</span></a>
      </div>
      <div class="text-center mt-3">
        <a href="{% url 'change_password' %}" class="btn btn-link">Change Password</a>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  (function(){
    const fileInput = document.getElementById('id_profile_photo');
    const wrapper = document.getElementById('avatarWrapper');
    let preview = document.getElementById('avatarPreview');

    if(wrapper && fileInput){
      wrapper.addEventListener('click', () => fileInput.click());
      wrapper.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); fileInput.click(); }});
      fileInput.addEventListener('change', e => {
        const file = e.target.files[0];
        if(!file) return;
        if(file.size > 5*1024*1024){
          alert('Image must be 5MB or smaller.');
          fileInput.value='';
          return;
        }
        const url = URL.createObjectURL(file);
        if(preview.tagName === 'IMG'){
          preview.src = url;
        } else {
          const img = document.createElement('img');
          img.id='avatarPreview';
          img.src=url;
          img.alt='Profile Photo';
          wrapper.replaceChild(img, preview);
          preview = img;
        }
      });
    }
  })();
</script>
{% endblock %}
