{% extends "base.html" %}
{% block title %}Scholaroid - Inbox{% endblock %}

{% block extra_css %}
<style>
  .inbox-shell { max-width: 900px; margin:0 auto; }
  .inbox-card { border-radius:18px; overflow:hidden; border:1px solid #e5e7eb; }
  .inbox-header { background: linear-gradient(45deg, var(--accent), #4facfe); color:#fff; font-weight:600; padding:18px 24px; display:flex; align-items:center; justify-content:space-between; }
  .inbox-header h1 { font-size:1.15rem; margin:0; font-weight:600; }
  .conv-item { position:relative; display:flex; gap:14px; padding:16px 22px; border-bottom:1px solid #f1f3f5; text-decoration:none; color:inherit; transition:background .18s ease, transform .18s ease; }
  .conv-item:last-child { border-bottom:none; }
  .conv-item:hover { background:#f8faff; transform:translateX(4px); }
  .conv-avatar { width:52px; height:52px; border-radius:50%; object-fit:cover; border:3px solid #f0f2f5; background:#eef3ff; display:flex; align-items:center; justify-content:center; font-weight:600; font-size:18px; color:var(--accent); }
  .conv-body { flex:1; min-width:0; display:flex; flex-direction:column; }
  .conv-top { display:flex; align-items:center; gap:8px; }
  .conv-name { font-weight:600; font-size:.95rem; }
  .role-chip { font-size:10px; text-transform:uppercase; letter-spacing:.5px; padding:2px 6px; border-radius:20px; background:#eef1f6; font-weight:600; }
  .conv-preview { font-size:.8rem; color:#66708a; margin-top:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:100%; }
  .conv-meta { display:flex; flex-direction:column; align-items:flex-end; gap:6px; min-width:72px; }
  .conv-time { font-size:.65rem; color:#8891a4; font-weight:500; }
  .unread-dot { width:12px; height:12px; border-radius:50%; box-shadow:0 0 0 4px rgba(0,0,0,.05); }
  .conv-item.unread .conv-name { color:#111; }
  .conv-item.unread .conv-preview { font-weight:500; color:#334155; }
  .inbox-empty { text-align:center; padding:70px 20px; color:#8b95a7; }
  .inbox-empty i { font-size:48px; margin-bottom:12px; display:block; }
  /* Role colors for unread dot */
  .role-admin { background:#006bb3; }
  .role-teacher { background:#28a745; }
  .role-student { background:#ffc107; }
  .role-parent { background:#17a2b8; }
  @media (max-width:600px){ .conv-item { padding:14px 16px; } .conv-avatar { width:46px; height:46px; font-size:16px; } }
  .tab-bar { display:flex; background:#fff; border-bottom:1px solid #e5e7eb; }
    .tab-btn { flex:1; padding:10px 0; background:transparent; border:none; font-weight:600; font-size:.8rem; letter-spacing:.5px; text-transform:uppercase; cursor:pointer; position:relative; }
    .tab-btn.active { color:var(--accent); }
    .tab-btn.active:after { content:""; position:absolute; left:20%; right:20%; bottom:0; height:3px; background:var(--accent); border-radius:3px 3px 0 0; }
    .tab-panel { display:none; }
    .tab-panel.active { display:block; }
    .search-form { position:relative; }
    .search-form i { position:absolute; left:10px; top:50%; transform:translateY(-50%); color:#64748b; font-size:14px; }
    .search-input { padding:6px 12px 6px 32px; border-radius:999px; border:1px solid #d0d7e2; font-size:.8rem; width:210px; background:#ffffff; }
    .search-input:focus { outline:none; border-color:var(--accent); box-shadow:0 0 0 3px rgba(24,117,255,.18); }
</style>
{% endblock %}

{% block content %}
<div class="inbox-shell mt-3">
  <div class="inbox-card shadow-sm">
    <div class="inbox-header">
      <h1><i class="bi bi-chat-dots-fill me-2"></i>Inbox</h1>
      <div style="display:flex; gap:8px;">
        <form method="get" action="" style="display:flex; gap:4px;">
          <input type="text" name="q" value="{{ search_term }}" placeholder="Search messages" style="padding:4px 8px; border-radius:8px; border:1px solid #ddd;">
          <button class="role-btn" type="submit" style="white-space:nowrap;"><span>Search</span></button>
        </form>
        {% if request.user.role == 'teacher' or request.user.role == 'admin' %}
          <a href="{% url 'create_group' %}" class="role-btn"><span><i class="bi bi-people"></i> New Group</span></a>
        {% endif %}
        <a href="{% url dashboard_url_name %}" class="role-btn"><span><i class="bi bi-arrow-left"></i> Back</span></a>
      </div>
    </div>
      <div class="tab-bar">
        <button class="tab-btn active" data-tab="direct">Direct</button>
        <button class="tab-btn" data-tab="groups">Groups</button>
      </div>
      <div id="tab-direct" class="tab-panel active">
  {% if conversations %}
      <div class="conv-list">
        {% for u in conversations %}
          {# Determine unread: unread_count annotation #}
          <a href="{% url 'conversation' u.id %}" class="conv-item {% if u.unread_count %}unread{% endif %}">
            {# Avatar #}
            {% if u.profile_photo %}
              <img src="{{ u.profile_photo.url }}" alt="avatar" class="conv-avatar">
            {% else %}
              <div class="conv-avatar">{{ u.get_full_name|default:u.username|slice:':1'|upper }}</div>
            {% endif %}
            <div class="conv-body">
              <div class="conv-top">
                <div class="conv-name">{{ u.get_full_name|default:u.username }}</div>
                <div class="role-chip">{{ u.role }}</div>
              </div>
              <div class="conv-preview">
                {% if u.latest_content %}{{ u.latest_content|truncatechars:70 }}{% else %}<em>No messages yet</em>{% endif %}
              </div>
            </div>
            <div class="conv-meta">
              <div class="conv-time">{% if u.latest_timestamp %}{{ u.latest_timestamp|date:"M d" }}<br>{{ u.latest_timestamp|date:"H:i" }}{% endif %}</div>
              {% if u.unread_count %}
                <div class="unread-dot role-{{ u.role|lower }}" title="{{ u.unread_count }} unread"></div>
              {% endif %}
            </div>
          </a>
        {% endfor %}
      </div>
    {% else %}
      <div class="inbox-empty">
        <i class="bi bi-inbox"></i>
        <p>No conversations yet</p>
      </div>
    {% endif %}
  </div>
      <div id="tab-groups" class="tab-panel">
        {% if groups %}
          <div class="conv-list">
            {% for g in groups %}
              <a href="{% url 'group_chat' g.id %}" class="conv-item">
                <div class="conv-avatar" style="border-radius:14px;">ðŸ‘¥</div>
                <div class="conv-body">
                  <div class="conv-top">
                    <div class="conv-name">{{ g.name }}</div>
                    <div class="role-chip">Group</div>
                  </div>
                  <div class="conv-preview">{{ g.messages.last.content|default:'No messages yet'|truncatechars:70 }}</div>
                </div>
                <div class="conv-meta">
                  {% if g.messages.last %}
                    <div class="conv-time">{{ g.messages.last.timestamp|date:"M d" }}<br>{{ g.messages.last.timestamp|date:"H:i" }}</div>
                  {% endif %}
                </div>
              </a>
            {% endfor %}
          </div>
        {% else %}
          <div class="inbox-empty">
            <i class="bi bi-people"></i>
            <p>No groups yet</p>
          </div>
        {% endif %}
      </div>
      {% if search_term %}
        <div style="padding:0 24px 24px;">
          <h2 style="font-size:1rem; font-weight:600;">Search Results ({{ search_results|length }})</h2>
          {% if search_results %}
            <ul style="list-style:none; padding:0; margin:8px 0; display:grid; gap:6px;">
              {% for r in search_results %}
                <li style="padding:10px 14px; border:1px solid #e2e8f0; border-radius:12px; background:#fff;">
                  <a style="text-decoration:none; color:inherit;" href="{% if r.type == 'group' %}{% url 'group_chat' r.group.id %}#msg-{{ r.id }}{% else %}{% url 'conversation' r.other.id %}#msg-{{ r.id }}{% endif %}">
                    <div style="font-size:.7rem; text-transform:uppercase; letter-spacing:.5px; color:#475569; margin-bottom:4px;">
                      {% if r.type == 'group' %}Group: {{ r.group.name }}{% else %}Direct with {{ r.other.get_full_name|default:r.other.username }}{% endif %}
                    </div>
                    <div style="font-size:.8rem; color:#0f172a;">
                      <strong>{{ r.sender.get_full_name|default:r.sender.username }}</strong> Â· {{ r.timestamp|date:"M d H:i" }}<br>
                      {{ r.content|truncatechars:160 }}
                      {% if r.file %}<br><span style="font-size:.65rem; color:#475569;">[Attachment]</span>{% endif %}
                    </div>
                  </a>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p style="color:#64748b; font-size:.85rem;">No matches for "{{ search_term }}".</p>
          {% endif %}
        </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
  {% block extra_js %}
  <script>
    document.querySelectorAll('.tab-btn').forEach(btn=>{
      btn.addEventListener('click',()=>{
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
        document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('tab-'+btn.dataset.tab).classList.add('active');
      });
    });
  </script>
  {% endblock %}
