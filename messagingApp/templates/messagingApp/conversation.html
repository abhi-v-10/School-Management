{% extends "base.html" %}
{% block title %}Chat{% endblock %}

{% block extra_css %}
<style>
  .chat-shell { max-width:900px; margin:0 auto; }
  .chat-card { border:1px solid #e5e7eb; border-radius:18px; overflow:hidden; display:flex; flex-direction:column; height:560px; backdrop-filter:blur(4px); }
  .chat-header { background:linear-gradient(45deg,var(--accent),#4facfe); color:#fff; padding:14px 20px; display:flex; align-items:center; justify-content:space-between; }
  .chat-header-left { display:flex; align-items:center; gap:12px; }
  .chat-avatar { width:48px; height:48px; border-radius:50%; object-fit:cover; background:#eef3ff; display:flex; align-items:center; justify-content:center; font-weight:600; font-size:18px; border:3px solid rgba(255,255,255,.4); }
  .chat-user-meta { line-height:1.1; }
  .chat-user-name { font-weight:600; font-size:.95rem; }
  .chat-user-role { font-size:.65rem; letter-spacing:.5px; text-transform:uppercase; opacity:.85; }
  .chat-body { flex:1; padding:20px 24px 10px; overflow-y:auto; background:#fafbfc; }
  .msg-row { margin-bottom:16px; display:flex; gap:10px; }
  .msg-row.self { flex-direction:row-reverse; }
  .msg-avatar { width:40px; height:40px; border-radius:50%; object-fit:cover; background:#eef2ff; display:flex; align-items:center; justify-content:center; font-weight:600; font-size:15px; border:2px solid #e5e9f2; }
  .bubble { max-width:62%; padding:10px 14px 20px; border-radius:16px; position:relative; font-size:.85rem; line-height:1.35; box-shadow:0 4px 10px rgba(0,0,0,.05); }
  .bubble:hover .msg-actions { opacity:1; transform:translateY(0); }
  .msg-actions { position:absolute; top:-12px; right:6px; background:#1e293b; color:#fff; border-radius:18px; padding:4px 6px; font-size:0; display:flex; gap:4px; align-items:center; opacity:0; transform:translateY(-6px); transition:.18s; }
  .msg-actions button { background:transparent; border:none; color:#fff; font-size:14px; cursor:pointer; display:inline-flex; align-items:center; justify-content:center; width:22px; height:22px; border-radius:50%; }
  .msg-actions button:hover { background:rgba(255,255,255,.15); }
  .reaction-picker { position:absolute; z-index:40; background:#fff; border:1px solid #e2e8f0; padding:6px 8px; border-radius:14px; display:flex; gap:6px; top:100%; right:0; box-shadow:0 6px 20px rgba(0,0,0,.12); }
  .reaction-picker button { background:#f1f5f9; border:none; padding:4px 6px; border-radius:10px; font-size:18px; cursor:pointer; }
  .reaction-picker button:hover { background:var(--accent); color:#fff; }
  .react-strip { position:absolute; left:14px; bottom:4px; display:flex; gap:4px; }
  .react-pill { background:rgba(0,0,0,.55); color:#fff; padding:2px 6px; font-size:.55rem; border-radius:12px; display:inline-flex; align-items:center; gap:2px; }
  .other .react-pill { background:#e2e8f0; color:#111; }
  .bubble .time { display:block; margin-top:6px; font-size:.6rem; opacity:.7; font-weight:500; }
  .self .bubble { background:var(--accent); color:#fff; border-bottom-right-radius:4px; }
  .other .bubble { background:#ffffff; color:#222; border-bottom-left-radius:4px; }
  /* Role-specific accent border for other user bubble */
  .other.role-admin .bubble { border:1px solid #006bb3; }
  .other.role-teacher .bubble { border:1px solid #28a745; }
  .other.role-student .bubble { border:1px solid #ffc107; }
  .other.role-parent .bubble { border:1px solid #17a2b8; }
  .chat-footer { padding:8px 12px 10px; background:#fff; border-top:1px solid #e5e7eb; }
  .chat-input-wrap { display:flex; gap:6px; align-items:center; }
  .chat-text { flex:1; resize:none; border:1px solid #d8dde3; border-radius:18px; padding:8px 14px; min-height:38px; max-height:110px; font-size:.8rem; background:#f1f5f9; line-height:1.2; }
  .chat-text:focus { outline:none; border-color:var(--accent); box-shadow:0 0 0 3px rgba(24,117,255,.15); }
  .send-btn { border:none; background:var(--accent); color:#fff; padding:10px 14px; border-radius:16px; display:inline-flex; align-items:center; gap:4px; font-weight:600; font-size:.75rem; }
  .send-btn:hover { background:color-mix(in srgb,var(--accent) 85%, #000); }
  .add-btn { background:#334155; }
  .add-btn:hover { background:#1e293b; }
  .attach-preview { display:flex; gap:8px; flex-wrap:wrap; margin:6px 4px 0; }
  .attach-chip { background:#e2e8f0; border-radius:12px; padding:4px 10px; font-size:.6rem; display:flex; align-items:center; gap:6px; }
  .attach-chip img { max-height:40px; border-radius:8px; display:block; }
  .react-strip { margin-top:4px; display:flex; gap:4px; flex-wrap:wrap; }
  .react-pill { background:rgba(0,0,0,.15); color:#fff; padding:2px 6px; font-size:.6rem; border-radius:12px; display:inline-flex; align-items:center; gap:4px; }
  .other .react-pill { background:#e2e8f0; color:#111; }
  .reaction-add { cursor:pointer; font-size:.9rem; opacity:.6; transition:.2s; }
  .reaction-add:hover { opacity:1; }
  .empty-chat { text-align:center; margin-top:120px; color:#97a0b3; }
  .empty-chat i { font-size:50px; display:block; margin-bottom:12px; }
  @media (max-width:700px){ .chat-card { height:calc(100vh - 160px); } .bubble { max-width:78%; } }
</style>
{% endblock %}

{% block content %}
<div class="chat-shell mt-3">
  <div class="chat-card shadow-sm">
    <div class="chat-header">
      <div class="chat-header-left">
        {% if other_user.profile_photo %}
          <img src="{{ other_user.profile_photo.url }}" class="chat-avatar" alt="avatar">
        {% else %}
          <div class="chat-avatar">{{ other_user.get_full_name|default:other_user.username|slice:':1'|upper }}</div>
        {% endif %}
        <div class="chat-user-meta">
          <div class="chat-user-name">{{ other_user.get_full_name|default:other_user.username }}</div>
          <div class="chat-user-role">{{ other_user.role }}</div>
        </div>
      </div>
      <a href="{% url 'inbox' %}" class="role-btn"><span><i class="bi bi-arrow-left"></i> Back</span></a>
    </div>
    <div class="chat-body" id="chatBody">
      {% if chat_messages %}
        {% for msg in chat_messages %}
          {% if msg.sender == user %}
            <div class="msg-row self" id="msg-{{ msg.id }}" data-mid="{{ msg.id }}">
              {% if user.profile_photo %}
                <img src="{{ user.profile_photo.url }}" class="msg-avatar" alt="me">
              {% else %}
                <div class="msg-avatar">{{ user.get_full_name|default:user.username|slice:':1'|upper }}</div>
              {% endif %}
              <div class="bubble" data-id="{{ msg.id }}">
                <div class="msg-actions"><button class="more-btn" data-mid="{{ msg.id }}">â‹¯</button></div>
                {{ msg.content|linebreaksbr }}
                {% if msg.file %}<br><a href="{{ msg.file.url }}" download class="attach-chip" style="background:#1e293b; color:#fff; text-decoration:none; font-size:.6rem;">Download</a>{% endif %}
                {% if msg.reactions.all %}
                  <div class="react-strip">
                    {% regroup msg.reactions.all by emoji as emoji_groups %}
                    {% for g in emoji_groups %}
                      <span class="react-pill" data-emoji="{{ g.grouper }}">{{ g.grouper }} {{ g.list|length }}</span>
                    {% endfor %}
                  </div>
                {% endif %}
                <div class="time">{{ msg.timestamp|date:"M d, H:i" }}</div>
              </div>
            </div>
          {% else %}
            <div class="msg-row other role-{{ msg.sender.role|lower }}" id="msg-{{ msg.id }}" data-mid="{{ msg.id }}">
              {% if msg.sender.profile_photo %}
                <img src="{{ msg.sender.profile_photo.url }}" class="msg-avatar" alt="avatar">
              {% else %}
                <div class="msg-avatar">{{ msg.sender.get_full_name|default:msg.sender.username|slice:':1'|upper }}</div>
              {% endif %}
              <div class="bubble" data-id="{{ msg.id }}">
                <div class="msg-actions"><button class="more-btn" data-mid="{{ msg.id }}">â‹¯</button></div>
                {{ msg.content|linebreaksbr }}
                {% if msg.file %}<br><a href="{{ msg.file.url }}" download class="attach-chip" style="background:#f1f5f9; color:#0f172a; text-decoration:none; font-size:.6rem;">Download</a>{% endif %}
                {% if msg.reactions.all %}
                  <div class="react-strip">
                    {% regroup msg.reactions.all by emoji as emoji_groups_other %}
                    {% for g in emoji_groups_other %}
                      <span class="react-pill" data-emoji="{{ g.grouper }}">{{ g.grouper }} {{ g.list|length }}</span>
                    {% endfor %}
                  </div>
                {% endif %}
                <div class="time">{{ msg.timestamp|date:"M d, H:i" }}</div>
              </div>
            </div>
          {% endif %}
        {% endfor %}
      {% else %}
        <div class="empty-chat"><i class="bi bi-chat-left-text"></i>No messages yet</div>
      {% endif %}
    </div>
    <div class="chat-footer">
      <form method="post" id="chatForm" autocomplete="off" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="chat-input-wrap">
          <textarea name="content" id="chatInput" class="chat-text" placeholder="Type a message..." required></textarea>
          <label for="fileInput" class="send-btn add-btn" title="Add attachment" style="padding:8px 12px;">
            <i class="bi bi-plus-lg"></i>
            <input type="file" id="fileInput" name="file" accept="image/*,.pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.zip" style="display:none;">
          </label>
          <button type="submit" class="send-btn" id="sendBtn" style="height:38px;"><i class="bi bi-send-fill"></i><span>Send</span></button>
        </div>
        <div class="attach-preview" id="attachPreview" style="display:none;"></div>
        <div class="mt-1 small text-muted">Press Enter to send â€¢ Shift+Enter for newline</div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  const chatBody = document.getElementById('chatBody');
  function scrollToBottom(){ chatBody.scrollTop = chatBody.scrollHeight; }
  scrollToBottom();

  const input = document.getElementById('chatInput');
  const form = document.getElementById('chatForm');
  // Enter key -> websocket send (no page reload)
  input.addEventListener('keydown', e => {
    if(e.key === 'Enter' && !e.shiftKey){
      e.preventDefault();
      const text = input.value.trim();
      if(!text) return;
      if(ws && ws.readyState === 1){ ws.send(JSON.stringify({action:'send', content:text})); input.value=''; }
      else { form.submit(); } // fallback if WS not open
    }
  });
  // Reactions with picker & live update
  function sendReaction(id, emoji){
    const fd = new FormData(); fd.append('emoji', emoji); fd.append('type','direct'); fd.append('id', id);
    fetch('{% url 'react_message' %}', {method:'POST', headers:{'X-CSRFToken':'{{ csrf_token }}'}, body:fd}).then(r=>r.json()).then(data=>{ if(data.reactions){ updateReactionStrip(id, data.reactions); }});
  }
  function updateReactionStrip(id, reactions){
    const bubble = document.querySelector('.bubble[data-id="'+id+'"]'); if(!bubble) return;
    let strip = bubble.querySelector('.react-strip'); if(!strip){ strip = document.createElement('div'); strip.className='react-strip'; bubble.appendChild(strip); }
    strip.innerHTML='';
    reactions.forEach(r=>{ const pill=document.createElement('span'); pill.className='react-pill'; pill.textContent=r.emoji+' '+r.count; strip.appendChild(pill); });
  }
  const EMOJIS=['ðŸ‘','â¤ï¸','ðŸ˜‚','ðŸ˜®','ðŸ˜¢'];
  let currentPicker=null;
  function openPicker(container, mid){ closePicker(); const picker=document.createElement('div'); picker.className='reaction-picker'; EMOJIS.forEach(e=>{const b=document.createElement('button'); b.textContent=e; b.onclick=()=>{ sendReaction(mid,e); closePicker(); }; picker.appendChild(b);}); container.appendChild(picker); currentPicker=picker; document.addEventListener('mousedown', outsideHandler); }
  function closePicker(){ if(currentPicker){ currentPicker.remove(); currentPicker=null; document.removeEventListener('mousedown', outsideHandler);} }
  function outsideHandler(ev){ if(currentPicker && !currentPicker.contains(ev.target)){ closePicker(); } }
  document.querySelectorAll('.more-btn').forEach(btn=> btn.addEventListener('click', e=>{ e.stopPropagation(); openPicker(btn.parentElement, btn.dataset.mid); }));
  document.addEventListener('dblclick', e=>{ const b=e.target.closest('.bubble'); if(!b) return; sendReaction(b.dataset.id,'ðŸ‘'); });
  // WebSocket realtime (init, new, older, typing)
  const wsScheme = location.protocol === 'https:' ? 'wss' : 'ws';
  const ws = new WebSocket(`${wsScheme}://${location.host}/ws/chat/{{ other_user.id }}/`);
  const typingBar = document.createElement('div'); typingBar.className='small text-muted'; typingBar.style.margin='3px 10px'; typingBar.style.display='none'; typingBar.id='typingBar'; typingBar.textContent='Typing...'; chatBody.after(typingBar);
  let oldestId = Array.from(document.querySelectorAll('.bubble')).map(b=>parseInt(b.dataset.id)).sort((a,b)=>a-b)[0] || null;
  ws.onmessage = e => { const data = JSON.parse(e.data); if(data.type==='new'){ appendMessage(data.message,true); } else if(data.type==='older'){ prependOlder(data.messages); } else if(data.type==='typing'){ typingBar.style.display='block'; clearTimeout(window._tHide); window._tHide=setTimeout(()=> typingBar.style.display='none', 1400); } else if(data.type==='reaction'){ updateReactionStrip(data.message_id, data.reactions); } };
  ws.onerror = () => { console.warn('WS error, falling back to long-poll'); if(!window._fallback){ window._fallback=true; startFallbackPoll(); } };
  ws.onclose = () => { if(!window._fallback){ console.warn('WS closed, fallback poll'); startFallbackPoll(); } };
  function startFallbackPoll(){ let lastId = oldestId; const loop=()=>{ fetch('{% url 'conversation_poll' other_user.id %}?after='+(lastId||0)).then(r=>r.json()).then(d=>{ (d.messages||[]).forEach(m=>{ appendMessage(m,true); lastId=Math.max(lastId||0,m.id); }); setTimeout(loop,3000); }).catch(()=> setTimeout(loop,5000)); }; loop(); }
  function appendMessage(m, autoscroll){ if(document.getElementById('msg-'+m.id)) return; const row=document.createElement('div'); row.className='msg-row '+(m.sender_id==={{ user.id }}?'self':'other'); row.id='msg-'+m.id; row.dataset.mid=m.id; row.innerHTML=`<div class=\"msg-avatar\">${m.sender_name.charAt(0).toUpperCase()}</div><div class=\"bubble\" data-id=\"${m.id}\"><div class=\"msg-actions\"><button class=\"more-btn\" data-mid=\"${m.id}\">â‹¯</button></div>${m.content.replace(/\n/g,'<br>')}<div class=\"time\">${new Date(m.timestamp).toLocaleString()}</div></div>`; chatBody.appendChild(row); if(autoscroll) scrollToBottom(); oldestId = Math.min(oldestId||m.id, m.id); bindMore(row); }
  function prependOlder(list){ if(!list.length) return; const prevHeight=chatBody.scrollHeight; list.forEach(m=>{ if(document.getElementById('msg-'+m.id)) return; const row=document.createElement('div'); row.className='msg-row '+(m.sender_id==={{ user.id }}?'self':'other'); row.id='msg-'+m.id; row.dataset.mid=m.id; row.innerHTML=`<div class=\"msg-avatar\">${m.sender_name.charAt(0).toUpperCase()}</div><div class=\"bubble\" data-id=\"${m.id}\"><div class=\"msg-actions\"><button class=\"more-btn\" data-mid=\"${m.id}\">â‹¯</button></div>${m.content.replace(/\n/g,'<br>')}<div class=\"time\">${new Date(m.timestamp).toLocaleString()}</div></div>`; chatBody.insertBefore(row, chatBody.firstChild); oldestId = Math.min(oldestId||m.id, m.id); bindMore(row); }); chatBody.scrollTop = chatBody.scrollHeight - prevHeight; }
  function bindMore(ctx){ ctx.querySelectorAll('.more-btn').forEach(btn=>{ if(!btn.dataset.bound){ btn.dataset.bound='1'; btn.addEventListener('click', e=>{ e.stopPropagation(); openPicker(btn.parentElement, btn.dataset.mid); }); }}); }
  // Infinite scroll older
  let loadingOlder=false; chatBody.addEventListener('scroll', ()=>{ if(chatBody.scrollTop<15 && !loadingOlder && oldestId){ loadingOlder=true; ws.send(JSON.stringify({action:'load_older', before: oldestId})); setTimeout(()=> loadingOlder=false, 700); }});
  // Typing indicator send throttle
  let typingCooldown=false; input.addEventListener('input', ()=>{ if(!typingCooldown){ ws.send(JSON.stringify({action:'typing'})); typingCooldown=true; setTimeout(()=> typingCooldown=false, 1000); }});
  // Intercept form submit -> if file or WS unavailable, use AJAX upload endpoint, else pure WS
  form.addEventListener('submit', e=>{ e.preventDefault(); const text=input.value.trim(); const hasFile=fileInput.files.length>0; if(!text && !hasFile) return; if(!hasFile && ws && ws.readyState===1){ ws.send(JSON.stringify({action:'send', content:text})); input.value=''; return; } const fd=new FormData(); fd.append('content', text); if(fileInput.files[0]) fd.append('file', fileInput.files[0]); fetch('{% url 'upload_direct' other_user.id %}', {method:'POST', headers:{'X-CSRFToken':'{{ csrf_token }}'}, body:fd}).then(r=>r.json()).then(resp=>{ if(resp.error){ console.warn(resp.error); return; } input.value=''; fileInput.value=''; preview.innerHTML=''; preview.style.display='none'; }).catch(err=>console.error(err)); });
  // Attachment preview
  const fileInput = document.getElementById('fileInput');
  const preview = document.getElementById('attachPreview');
  fileInput.addEventListener('change', () => {
    preview.innerHTML='';
    if(!fileInput.files.length){ preview.style.display='none'; return; }
    [...fileInput.files].forEach(f => {
      const ext = f.name.split('.').pop().toLowerCase();
      const chip = document.createElement('div');
      chip.className='attach-chip';
      if(['png','jpg','jpeg','gif','webp','bmp'].includes(ext)){
        const img = document.createElement('img');
        img.src = URL.createObjectURL(f);
        chip.appendChild(img);
      } else {
        chip.innerHTML = `<i class="bi bi-paperclip"></i> ${f.name.substring(0,18)}`;
      }
      preview.appendChild(chip);
    });
    preview.style.display='flex';
  });
</script>
{% endblock %}
